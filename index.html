<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Injury Report</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg: #0a0a0c;
  --surface: #141418;
  --surface2: #1c1c22;
  --border: #2a2a32;
  --text: #e8e8ec;
  --text2: #8a8a96;
  --accent: #3b82f6;
  --out: #ef4444;
  --doubtful: #f97316;
  --questionable: #eab308;
  --probable: #22c55e;
  --available: #10b981;
  --modified-bg: rgba(59,130,246,0.06);
  --modified-border: rgba(59,130,246,0.25);
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* ============ ADMIN VIEW ============ */
.admin-container { max-width:1100px; margin:0 auto; padding:16px 20px 80px; }

.admin-header {
  display:flex; align-items:center; gap:16px; padding:20px 0 16px;
  border-bottom:1px solid var(--border); margin-bottom:16px;
}
.admin-header h1 { font-size:20px; font-weight:700; letter-spacing:-0.02em; }
.admin-header .subtitle { color:var(--text2); font-size:13px; margin-left:auto; }

/* Sticky toolbar */
.admin-toolbar {
  position:sticky; top:0; z-index:100; background:var(--bg);
  border-bottom:1px solid var(--border);
  padding:10px 0; margin-bottom:16px;
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.admin-toolbar button {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid var(--border);
  background:var(--surface); color:var(--text); cursor:pointer;
  transition:all 0.15s;
}
.admin-toolbar button:hover { background:var(--surface2); border-color:#444; }
.admin-toolbar button.primary { background:var(--accent); border-color:var(--accent); color:#fff; }
.admin-toolbar button.primary:hover { background:#2563eb; }
.admin-toolbar button.success { background:#059669!important; border-color:#059669!important; color:#fff!important; }
.admin-toolbar .spacer { flex:1; }
.admin-toolbar .badge {
  font-family:'JetBrains Mono',monospace; font-size:11px; font-weight:500;
  padding:4px 10px; border-radius:99px; background:var(--surface2); color:var(--text2);
}
.admin-toolbar .badge.has-changes { background:rgba(59,130,246,0.15); color:var(--accent); }

/* Search / filter */
.filter-bar {
  display:flex; gap:8px; margin-bottom:16px; align-items:center;
}
.filter-bar input {
  font-family:inherit; font-size:13px; padding:8px 12px; border-radius:6px;
  border:1px solid var(--border); background:var(--surface); color:var(--text);
  flex:1; max-width:320px; outline:none;
}
.filter-bar input:focus { border-color:var(--accent); }
.filter-bar .filter-btn {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 12px; border-radius:6px; border:1px solid var(--border);
  background:var(--surface); color:var(--text2); cursor:pointer; transition:all 0.15s;
}
.filter-bar .filter-btn:hover { color:var(--text); border-color:#444; }
.filter-bar .filter-btn.active { background:var(--accent); border-color:var(--accent); color:#fff; }

/* Team sections */
.team-section { margin-bottom:8px; }
.team-header {
  display:flex; align-items:center; gap:10px; padding:10px 12px;
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  cursor:pointer; user-select:none; transition:all 0.15s;
}
.team-header:hover { background:var(--surface2); }
.team-header img { width:28px; height:28px; }
.team-header .team-name { font-size:14px; font-weight:600; }
.team-header .team-count { font-size:12px; color:var(--text2); margin-left:auto; }
.team-header .team-injured {
  font-size:11px; font-weight:600; padding:2px 8px; border-radius:99px;
  background:rgba(239,68,68,0.12); color:var(--out);
}
.team-header .team-injured.none { display:none; }
.team-header .chevron {
  color:var(--text2); font-size:14px; transition:transform 0.2s;
  margin-left:8px;
}
.team-section.collapsed .chevron { transform:rotate(-90deg); }
.team-section.collapsed .team-players { display:none; }

.team-players { border:1px solid var(--border); border-top:none; border-radius:0 0 8px 8px; overflow:hidden; }

/* Player row */
.player-row {
  display:grid;
  grid-template-columns: 1fr 90px 130px 1fr 110px;
  gap:8px; align-items:center;
  padding:6px 12px; border-bottom:1px solid var(--border);
  font-size:13px; transition:background 0.15s;
}
.player-row:last-child { border-bottom:none; }
.player-row:hover { background:rgba(255,255,255,0.02); }
.player-row.modified { background:var(--modified-bg); border-color:var(--modified-border); }

.player-name { font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.player-salary { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--text2); text-align:right; }

.player-row select {
  font-family:inherit; font-size:12px; font-weight:600; padding:4px 6px;
  border-radius:4px; border:1px solid var(--border); background:var(--surface);
  color:var(--text); cursor:pointer; outline:none; width:100%;
}
.player-row select:focus { border-color:var(--accent); }
.player-row select.s-out { color:var(--out); }
.player-row select.s-doubtful { color:var(--doubtful); }
.player-row select.s-questionable { color:var(--questionable); }
.player-row select.s-probable { color:var(--probable); }
.player-row select.s-available { color:var(--available); }

.player-row input[type="text"] {
  font-family:inherit; font-size:12px; padding:4px 6px;
  border-radius:4px; border:1px solid var(--border); background:var(--surface);
  color:var(--text); outline:none; width:100%;
}
.player-row input[type="text"]:focus { border-color:var(--accent); }
.player-row input[type="text"].inactive { color:var(--text2); border-color:transparent; background:transparent; }

.player-row input[type="date"] {
  font-family:'JetBrains Mono',monospace; font-size:11px; padding:4px 4px;
  border-radius:4px; border:1px solid var(--border); background:var(--surface);
  color:var(--text); outline:none; width:100%;
  color-scheme:dark;
}
.player-row input[type="date"]:focus { border-color:var(--accent); }
.player-row input[type="date"].inactive { color:var(--text2); border-color:transparent; background:transparent; }

/* Column headers */
.col-headers {
  display:grid;
  grid-template-columns: 1fr 90px 130px 1fr 110px;
  gap:8px; padding:8px 12px;
  font-size:11px; font-weight:600; color:var(--text2); text-transform:uppercase; letter-spacing:0.05em;
  background:var(--surface); border-bottom:1px solid var(--border);
  position:sticky; top:50px; z-index:50;
}
.col-headers span:nth-child(2) { text-align:right; }

/* Loading state */
.loading-state {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:80px 0; color:var(--text2);
}
.loading-spinner {
  width:32px; height:32px; border:3px solid var(--border); border-top-color:var(--accent);
  border-radius:50%; animation:spin 0.8s linear infinite; margin-bottom:16px;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* ============ REPORT VIEW (non-admin) ============ */
.report-container { max-width:900px; margin:0 auto; padding:16px 20px 80px; }

.report-toolbar {
  display:flex; gap:8px; flex-wrap:wrap; padding:12px 0;
  border-bottom:1px solid var(--border); margin-bottom:16px;
}
.report-toolbar button {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid var(--border);
  background:var(--surface); color:var(--text); cursor:pointer; transition:all 0.15s;
}
.report-toolbar button:hover { background:var(--surface2); }
.report-toolbar button.success { background:#059669!important; border-color:#059669!important; color:#fff!important; }

.tab-bar { display:flex; gap:4px; margin-bottom:16px; }
.tab-bar button {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid transparent;
  background:transparent; color:var(--text2); cursor:pointer; transition:all 0.15s;
}
.tab-bar button:hover { color:var(--text); }
.tab-bar button.active { background:var(--surface); color:var(--text); border-color:var(--border); }

.preview { padding:8px 0; }
.preview table { font-size:13px; }

.error-msg { padding:40px; text-align:center; color:var(--out); }

/* Purge button */
.btn-purge {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid rgba(239,68,68,0.3);
  background:rgba(239,68,68,0.08); color:var(--out); cursor:pointer; transition:all 0.15s;
}
.btn-purge:hover { background:rgba(239,68,68,0.15); }
</style>
</head>
<body>

<script>
// ===== CONFIG =====
const SHEET_ID = '2PACX-1vQ-TNS1Zxbcq2Altxh0-yY0LFEPvOXlwI8DjD8FdbSypf_sSWc3Xi6F88DwiOdSmR0FmXLzNicgCDwL';
const INJ_GID = '306285159';
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${INJ_GID}&single=true&output=csv`;
const JSON_URL = 'injuries.json';

const NBA_TEAMS = [
  'Atlanta','Boston','Brooklyn','Charlotte','Chicago','Cleveland',
  'Dallas','Denver','Detroit','Golden State','Houston','Indiana',
  'LA Clippers','LA Lakers','Memphis','Miami','Milwaukee','Minnesota',
  'New Orleans','New York','Oklahoma City','Orlando','Philadelphia','Phoenix',
  'Portland','Sacramento','San Antonio','Toronto','Utah','Washington'
];
const TEAM_IDS = {
  'Atlanta':1610612737,'Boston':1610612738,'Brooklyn':1610612751,
  'Charlotte':1610612766,'Chicago':1610612741,'Cleveland':1610612739,
  'Dallas':1610612742,'Denver':1610612743,'Detroit':1610612765,
  'Golden State':1610612744,'Houston':1610612745,'Indiana':1610612754,
  'LA Clippers':1610612746,'LA Lakers':1610612747,'Memphis':1610612763,
  'Miami':1610612748,'Milwaukee':1610612749,'Minnesota':1610612750,
  'New Orleans':1610612740,'New York':1610612752,'Oklahoma City':1610612760,
  'Orlando':1610612753,'Philadelphia':1610612755,'Phoenix':1610612756,
  'Portland':1610612757,'Sacramento':1610612758,'San Antonio':1610612759,
  'Toronto':1610612761,'Utah':1610612762,'Washington':1610612764
};
const TEAM_ABBREV = {
  'Atlanta':'ATL','Boston':'BOS','Brooklyn':'BKN','Charlotte':'CHA','Chicago':'CHI','Cleveland':'CLE',
  'Dallas':'DAL','Denver':'DEN','Detroit':'DET','Golden State':'GSW','Houston':'HOU','Indiana':'IND',
  'LA Clippers':'LAC','LA Lakers':'LAL','Memphis':'MEM','Miami':'MIA','Milwaukee':'MIL','Minnesota':'MIN',
  'New Orleans':'NOP','New York':'NYK','Oklahoma City':'OKC','Orlando':'ORL','Philadelphia':'PHI','Phoenix':'PHX',
  'Portland':'POR','Sacramento':'SAC','San Antonio':'SAS','Toronto':'TOR','Utah':'UTA','Washington':'WAS'
};
const STATUSES = ['Available','Probable','Questionable','Doubtful','Out'];
const STATUS_GRAVITY = { 'Out':0,'Doubtful':1,'Questionable':2,'Probable':3,'Available':4 };

function teamLogo(t) { const id=TEAM_IDS[t]; return id ? `https://cdn.nba.com/logos/nba/${id}/primary/L/logo.svg` : ''; }
function fmtSal(n) { if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M'; if(n>=1e3) return '$'+(n/1e3).toFixed(0)+'K'; return '$'+n.toLocaleString(); }
function fmtSalFull(n) { return '$'+n.toLocaleString(); }
function fmtDate(iso) { const d=new Date(iso+'T00:00:00'); const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return m[d.getMonth()]+' '+d.getDate(); }
function sColor(s) { return {Out:'#ef4444',Doubtful:'#f97316',Questionable:'#eab308',Probable:'#22c55e',Available:'#10b981'}[s]||'#888'; }
function sSpan(s) { return `<span style="color:${sColor(s)};font-weight:700;">${s}</span>`; }
function statusClass(s) { return 's-'+s.toLowerCase(); }
function todayISO() { return new Date().toISOString().slice(0,10); }

function parseCSV(text) {
  const rows=[]; let cur='',inQ=false,row=[];
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c==='"'){if(inQ&&text[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
    else if(c===','&&!inQ){row.push(cur);cur='';}
    else if((c==='\n'||c==='\r')&&!inQ){if(c==='\r'&&text[i+1]==='\n')i++;row.push(cur);cur='';rows.push(row);row=[];}
    else cur+=c;
  }
  if(cur||row.length){row.push(cur);rows.push(row);}
  return rows;
}

// ===== SHARED STATE =====
let roster = {};      // player -> {team, salary}
let teamSalaries = {}; // team -> total salary
let daysMap = {};     // player -> days since last game
let jsonEntries = []; // raw injuries.json
let latestStatus = {}; // player -> {status, injury, date}
let modifications = {}; // player -> {status, injury, date} (admin edits)

// ===== DATA LOADING =====
async function loadData() {
  const [csvR, jsonR] = await Promise.all([
    fetch(CSV_URL),
    fetch(JSON_URL + '?t=' + Date.now())
  ]);
  if (!csvR.ok) throw new Error('CSV fetch failed: ' + csvR.status);
  if (!jsonR.ok) throw new Error('injuries.json fetch failed: ' + jsonR.status);

  const csvText = await csvR.text();
  const injuries = await jsonR.json();
  const rows = parseCSV(csvText);

  // Roster: cols 38(team), 40(player), 44(salary)
  roster = {}; teamSalaries = {};
  for (const r of rows) {
    if (r.length > 44) {
      const team = (r[38]||'').trim(), player = (r[40]||'').trim(), sal = (r[44]||'').trim();
      if (player && player !== 'PLAYER' && team && /^\d+$/.test(sal)) {
        roster[player] = { team, salary: parseInt(sal) };
        teamSalaries[team] = (teamSalaries[team]||0) + parseInt(sal);
      }
    }
  }

  // Days since last game: cols 71(player), 73(days)
  daysMap = {};
  for (const r of rows) {
    if (r.length > 73) {
      const p = (r[71]||'').trim(), d = (r[73]||'').trim();
      if (p && /^\d+$/.test(d)) daysMap[p] = parseInt(d);
    }
  }

  // Process JSON entries
  jsonEntries = injuries;
  latestStatus = {};
  const prev = {};
  for (const e of injuries) {
    if (latestStatus[e.player]) prev[e.player] = latestStatus[e.player];
    latestStatus[e.player] = { status: e.status, injury: e.injury, date: e.date };
  }

  return { prev };
}

// ===== IS ADMIN? =====
const isAdmin = new URLSearchParams(window.location.search).has('admin');

if (isAdmin) {
  document.body.innerHTML = `
    <div class="admin-container">
      <div class="admin-header">
        <h1>üè• Injury Report ‚Äî Admin</h1>
        <span class="subtitle" id="lastUpdate"></span>
      </div>
      <div class="admin-toolbar" id="toolbar">
        <button class="primary" onclick="copyJSON(this)">üìã Copy Updated JSON</button>
        <button onclick="window.open('https://github.com/aderoa/Injuries/edit/main/injuries.json','_blank')">‚úèÔ∏è Open on GitHub</button>
        <button onclick="copyPrestoHTML(this)">üìã Copy Presto HTML</button>
        <button onclick="resetAll()">‚Ü© Reset All</button>
        <span class="spacer"></span>
        <span class="badge" id="changesBadge">0 changes</span>
      </div>
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="Search player or team..." oninput="filterPlayers()">
        <button class="filter-btn" onclick="toggleFilter('modified',this)" title="Show only modified">‚úé Modified</button>
        <button class="filter-btn" onclick="toggleFilter('injured',this)" title="Show only injured">üî¥ Injured</button>
        <button class="filter-btn" onclick="toggleFilter('available',this)" title="Show only available">üü¢ Available</button>
      </div>
      <div class="col-headers">
        <span>Player</span><span>Salary</span><span>Status</span><span>Injury</span><span>Date</span>
      </div>
      <div id="rosterArea"><div class="loading-state"><div class="loading-spinner"></div><p>Loading roster...</p></div></div>
    </div>
  `;
  initAdmin();
} else {
  document.body.innerHTML = `
    <div class="report-container">
      <div class="admin-header">
        <h1>üè• NBA Injury Report</h1>
      </div>
      <div class="report-toolbar" id="reportToolbar">
        <button onclick="copyAll(this)">üìã Copy Full Report</button>
        <button onclick="copySection(0,this)">üìã Today's Updates</button>
        <button onclick="copySection(1,this)">üìã Full Report</button>
        <button onclick="copySection(2,this)">üìã Salary Per Team</button>
        <button onclick="copySection(3,this)">üìã Highest-Paid</button>
        <button onclick="refreshReport(this)">üîÑ Refresh</button>
        <button class="btn-purge" onclick="togglePurge(this)">üßπ Purge Available</button>
      </div>
      <div class="tab-bar" id="tabBar">
        <button onclick="showTab(0,this)">Today's Updates</button>
        <button onclick="showTab(1,this)">Full Report</button>
        <button onclick="showTab(2,this)">Salary Per Team</button>
        <button onclick="showTab(3,this)">Highest-Paid</button>
        <button class="active" onclick="showTab(-1,this)">All</button>
      </div>
      <div id="loading" class="loading-state"><div class="loading-spinner"></div><p>Loading injury data...</p></div>
      <div id="preview" class="preview" style="display:none;"></div>
      <div id="error" class="error-msg" style="display:none;"></div>
    </div>
  `;
  initReport();
}

// ==========================================
// ADMIN MODE
// ==========================================
let activeFilter = null;

async function initAdmin() {
  try {
    await loadData();
    document.getElementById('lastUpdate').textContent = `${Object.keys(roster).length} players loaded`;
    renderRoster();
  } catch(e) {
    document.getElementById('rosterArea').innerHTML = `<div class="error-msg">Error: ${e.message}</div>`;
  }
}

function renderRoster() {
  const area = document.getElementById('rosterArea');
  let html = '';

  for (const team of NBA_TEAMS) {
    const players = Object.entries(roster)
      .filter(([_,v]) => v.team === team)
      .sort((a,b) => b[1].salary - a[1].salary);
    if (!players.length) continue;

    const injuredCount = players.filter(([name]) => {
      const mod = modifications[name];
      const cur = mod || latestStatus[name];
      return cur && cur.status !== 'Available';
    }).length;

    html += `<div class="team-section" data-team="${team}" id="team-${team.replace(/\s/g,'')}">`;
    html += `<div class="team-header" onclick="toggleTeam(this)">`;
    html += `<img src="${teamLogo(team)}" alt="${team}">`;
    html += `<span class="team-name">${team}</span>`;
    html += `<span class="team-count">${players.length} players</span>`;
    html += `<span class="team-injured ${injuredCount?'':'none'}">${injuredCount} injured</span>`;
    html += `<span class="chevron">‚ñº</span>`;
    html += `</div>`;
    html += `<div class="team-players">`;

    for (const [name, info] of players) {
      const cur = modifications[name] || latestStatus[name] || { status:'Available', injury:'', date:'' };
      const isModified = !!modifications[name];
      const isAvail = cur.status === 'Available';

      html += `<div class="player-row ${isModified?'modified':''}" data-player="${name}" data-team="${team}">`;
      html += `<span class="player-name" title="${name}">${name}</span>`;
      html += `<span class="player-salary">${fmtSal(info.salary)}</span>`;

      // Status select
      html += `<select class="${statusClass(cur.status)}" onchange="onStatusChange('${name.replace(/'/g,"\\'")}',this)">`;
      for (const s of STATUSES) {
        html += `<option value="${s}" ${s===cur.status?'selected':''}>${s}</option>`;
      }
      html += `</select>`;

      // Injury input
      html += `<input type="text" value="${cur.injury||''}" class="${isAvail?'inactive':''}" placeholder="${isAvail?'‚Äî':'Injury reason'}" onchange="onInjuryChange('${name.replace(/'/g,"\\'")}',this)" onfocus="this.classList.remove('inactive')">`;

      // Date input
      html += `<input type="date" value="${cur.date||''}" class="${isAvail?'inactive':''}" onchange="onDateChange('${name.replace(/'/g,"\\'")}',this)">`;

      html += `</div>`;
    }

    html += `</div></div>`;
  }

  area.innerHTML = html;
}

function toggleTeam(el) {
  el.closest('.team-section').classList.toggle('collapsed');
}

function getEffectiveStatus(name) {
  return modifications[name] || latestStatus[name] || { status:'Available', injury:'', date:'' };
}

function onStatusChange(name, sel) {
  const row = sel.closest('.player-row');
  const injInput = row.querySelector('input[type="text"]');
  const dateInput = row.querySelector('input[type="date"]');
  const newStatus = sel.value;

  // Determine the original status from JSON
  const original = latestStatus[name] || { status:'Available', injury:'', date:'' };

  // Update select color class
  sel.className = statusClass(newStatus);

  if (newStatus === original.status && !injInput.value && !dateInput.value) {
    // Reverted to original ‚Äî remove modification
    delete modifications[name];
    row.classList.remove('modified');
    injInput.className = newStatus==='Available' ? 'inactive' : '';
    dateInput.className = newStatus==='Available' ? 'inactive' : '';
  } else {
    // Set default date to today if empty
    if (!dateInput.value) dateInput.value = todayISO();
    // Carry forward injury from JSON if available and field empty
    if (!injInput.value && original.injury && newStatus !== 'Available') {
      injInput.value = original.injury;
    }

    modifications[name] = {
      status: newStatus,
      injury: injInput.value,
      date: dateInput.value
    };
    row.classList.add('modified');
    injInput.classList.remove('inactive');
    dateInput.classList.remove('inactive');
  }

  updateBadge();
  updateTeamInjuredCounts();
}

function onInjuryChange(name, inp) {
  const row = inp.closest('.player-row');
  const sel = row.querySelector('select');
  const dateInput = row.querySelector('input[type="date"]');
  const original = latestStatus[name] || { status:'Available', injury:'', date:'' };

  if (sel.value === original.status && !inp.value && !dateInput.value) {
    delete modifications[name];
    row.classList.remove('modified');
  } else {
    if (!dateInput.value) dateInput.value = todayISO();
    modifications[name] = { status: sel.value, injury: inp.value, date: dateInput.value };
    row.classList.add('modified');
  }
  updateBadge();
}

function onDateChange(name, inp) {
  const row = inp.closest('.player-row');
  const sel = row.querySelector('select');
  const injInput = row.querySelector('input[type="text"]');
  const original = latestStatus[name] || { status:'Available', injury:'', date:'' };

  if (sel.value === original.status && !injInput.value && !inp.value) {
    delete modifications[name];
    row.classList.remove('modified');
  } else {
    modifications[name] = { status: sel.value, injury: injInput.value, date: inp.value };
    row.classList.add('modified');
  }
  updateBadge();
}

function updateBadge() {
  const count = Object.keys(modifications).length;
  const badge = document.getElementById('changesBadge');
  badge.textContent = `${count} change${count!==1?'s':''}`;
  badge.className = count ? 'badge has-changes' : 'badge';
}

function updateTeamInjuredCounts() {
  document.querySelectorAll('.team-section').forEach(sec => {
    const team = sec.dataset.team;
    const rows = sec.querySelectorAll('.player-row');
    let injured = 0;
    rows.forEach(r => {
      const sel = r.querySelector('select');
      if (sel && sel.value !== 'Available') injured++;
    });
    const badge = sec.querySelector('.team-injured');
    if (badge) {
      badge.textContent = `${injured} injured`;
      badge.classList.toggle('none', injured === 0);
    }
  });
}

function filterPlayers() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('.team-section').forEach(sec => {
    let anyVisible = false;
    sec.querySelectorAll('.player-row').forEach(row => {
      const name = row.dataset.player.toLowerCase();
      const team = row.dataset.team.toLowerCase();
      let show = !q || name.includes(q) || team.includes(q);

      // Apply active filter
      if (show && activeFilter === 'modified') show = row.classList.contains('modified');
      if (show && activeFilter === 'injured') {
        const sel = row.querySelector('select');
        show = sel && sel.value !== 'Available';
      }
      if (show && activeFilter === 'available') {
        const sel = row.querySelector('select');
        show = sel && sel.value === 'Available';
      }

      row.style.display = show ? '' : 'none';
      if (show) anyVisible = true;
    });
    sec.style.display = anyVisible ? '' : 'none';
    if (anyVisible) sec.classList.remove('collapsed');
  });
}

function toggleFilter(type, btn) {
  if (activeFilter === type) {
    activeFilter = null;
    btn.classList.remove('active');
  } else {
    activeFilter = type;
    document.querySelectorAll('.filter-bar .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  filterPlayers();
}

function resetAll() {
  if (Object.keys(modifications).length && !confirm('Reset all changes?')) return;
  modifications = {};
  renderRoster();
  updateBadge();
}

// ===== JSON GENERATION =====
function buildMergedJSON() {
  // Start with original entries
  const merged = [...jsonEntries];

  // Append modifications as new entries
  for (const [player, mod] of Object.entries(modifications)) {
    merged.push({
      player,
      status: mod.status,
      injury: mod.injury || '',
      date: mod.date || todayISO()
    });
  }

  return merged;
}

function copyJSON(btn) {
  const merged = buildMergedJSON();
  const json = JSON.stringify(merged, null, 2);
  navigator.clipboard.writeText(json).then(() => {
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!'; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
  });
}

// ===== PRESTO HTML GENERATION (same 4 tables) =====
function buildPrestoHTML() {
  const merged = buildMergedJSON();

  // Rebuild latest + prev from merged
  const lat = {}, prv = {};
  for (const e of merged) {
    if (lat[e.player]) prv[e.player] = lat[e.player];
    lat[e.player] = e;
  }

  const today = todayISO();
  const tStyle = 'border-collapse:collapse;width:100%;font-family:Arial,sans-serif;font-size:14px;';
  const thStyle = 'background:#1a1a2e;color:#fff;padding:10px 12px;text-align:left;border:1px solid #333;';
  const tdS = 'padding:8px 12px;border:1px solid #ddd;';

  // Table 1: Today's Updates
  const todayEntries = merged.filter(e => e.date === today).map(e => {
    const p = prv[e.player], r = roster[e.player] || {};
    return { player:e.player, status:e.status, injury:e.injury, prevStatus:p?p.status:'Available', team:r.team||'', salary:r.salary||0 };
  }).sort((a,b) => {
    if (a.team !== b.team) return a.team.localeCompare(b.team);
    return (STATUS_GRAVITY[a.status]||4) - (STATUS_GRAVITY[b.status]||4);
  });

  let t1 = `<table style="${tStyle}"><thead><tr>`;
  t1 += `<th style="${thStyle}">Team</th><th style="${thStyle}">Player</th><th style="${thStyle}">Status</th><th style="${thStyle}">Injury</th><th style="${thStyle}">Prev</th>`;
  t1 += `</tr></thead><tbody>`;
  if (!todayEntries.length) {
    t1 += `<tr><td colspan="5" style="${tdS}text-align:center;color:#888;">No updates today</td></tr>`;
  }
  for (const e of todayEntries) {
    const logo = TEAM_IDS[e.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[e.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t1 += `<tr><td style="${tdS}">${logo} ${TEAM_ABBREV[e.team]||e.team}</td>`;
    t1 += `<td style="${tdS}font-weight:600;">${e.player}</td>`;
    t1 += `<td style="${tdS}color:${sColor(e.status)};font-weight:700;">${e.status}</td>`;
    t1 += `<td style="${tdS}">${e.injury}</td>`;
    t1 += `<td style="${tdS}color:${sColor(e.prevStatus)};font-weight:700;">${e.prevStatus}</td></tr>`;
  }
  t1 += `</tbody></table>`;

  // Table 2: Full Report
  const allInjured = Object.entries(lat)
    .filter(([_,e]) => e.status !== 'Available')
    .map(([name,e]) => ({ player:name, ...e, team:(roster[name]||{}).team||'', salary:(roster[name]||{}).salary||0, days:daysMap[name]||0 }))
    .sort((a,b) => {
      if (a.team !== b.team) return a.team.localeCompare(b.team);
      return (STATUS_GRAVITY[a.status]||4) - (STATUS_GRAVITY[b.status]||4);
    });

  let t2 = `<table style="${tStyle}"><thead><tr>`;
  t2 += `<th style="${thStyle}">Team</th><th style="${thStyle}">Player</th><th style="${thStyle}">Status</th><th style="${thStyle}">Injury</th><th style="${thStyle}">Since</th><th style="${thStyle}">Days</th><th style="${thStyle}">Salary</th>`;
  t2 += `</tr></thead><tbody>`;
  for (const e of allInjured) {
    const logo = TEAM_IDS[e.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[e.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t2 += `<tr><td style="${tdS}">${logo} ${TEAM_ABBREV[e.team]||e.team}</td>`;
    t2 += `<td style="${tdS}font-weight:600;">${e.player}</td>`;
    t2 += `<td style="${tdS}color:${sColor(e.status)};font-weight:700;">${e.status}</td>`;
    t2 += `<td style="${tdS}">${e.injury||''}</td>`;
    t2 += `<td style="${tdS}">${e.date ? fmtDate(e.date) : ''}</td>`;
    t2 += `<td style="${tdS}text-align:center;">${e.days||''}</td>`;
    t2 += `<td style="${tdS}text-align:right;">${fmtSal(e.salary)}</td></tr>`;
  }
  t2 += `</tbody></table>`;

  // Table 3: Salary Per Team
  const teamInjSal = {};
  for (const e of allInjured) {
    if (e.status === 'Out' || e.status === 'Doubtful') {
      teamInjSal[e.team] = (teamInjSal[e.team]||0) + e.salary;
    }
  }
  let totalNBASal = 0, totalNBAInj = 0;
  for (const t of NBA_TEAMS) { totalNBASal += teamSalaries[t]||0; totalNBAInj += teamInjSal[t]||0; }

  const teamRows = NBA_TEAMS.map(t => ({
    team:t, injured:teamInjSal[t]||0, total:teamSalaries[t]||0,
    pct: teamSalaries[t] ? ((teamInjSal[t]||0)/teamSalaries[t]*100) : 0
  })).sort((a,b) => b.injured - a.injured);

  let t3 = `<table style="${tStyle}"><thead><tr>`;
  t3 += `<th style="${thStyle}">Team</th><th style="${thStyle}">Injured Salary</th><th style="${thStyle}">Total Salary</th><th style="${thStyle}">%</th>`;
  t3 += `</tr></thead><tbody>`;
  for (const r of teamRows) {
    const logo = TEAM_IDS[r.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[r.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t3 += `<tr><td style="${tdS}">${logo} ${r.team}</td>`;
    t3 += `<td style="${tdS}text-align:right;font-weight:600;${r.injured?'color:#ef4444;':''}">${fmtSalFull(r.injured)}</td>`;
    t3 += `<td style="${tdS}text-align:right;">${fmtSalFull(r.total)}</td>`;
    t3 += `<td style="${tdS}text-align:right;">${r.pct.toFixed(1)}%</td></tr>`;
  }
  // NBA total row
  const nbaLogo = `<img src="https://cdn.nba.com/logos/leagues/logo-nba.svg" width="24" height="24" style="vertical-align:middle;">`;
  t3 += `<tr style="background:#1a1a2e;color:#fff;font-weight:700;">`;
  t3 += `<td style="${tdS}border-color:#333;">${nbaLogo} NBA</td>`;
  t3 += `<td style="${tdS}text-align:right;border-color:#333;color:#ef4444;">${fmtSalFull(totalNBAInj)}</td>`;
  t3 += `<td style="${tdS}text-align:right;border-color:#333;">${fmtSalFull(totalNBASal)}</td>`;
  t3 += `<td style="${tdS}text-align:right;border-color:#333;">${totalNBASal?(totalNBAInj/totalNBASal*100).toFixed(1):'0.0'}%</td></tr>`;
  t3 += `</tbody></table>`;

  // Table 4: Highest-Paid Injured
  const topPaid = [...allInjured].sort((a,b) => b.salary - a.salary).slice(0,25);
  let t4 = `<table style="${tStyle}"><thead><tr>`;
  t4 += `<th style="${thStyle}">#</th><th style="${thStyle}">Team</th><th style="${thStyle}">Player</th><th style="${thStyle}">Status</th><th style="${thStyle}">Injury</th><th style="${thStyle}">Salary</th>`;
  t4 += `</tr></thead><tbody>`;
  topPaid.forEach((e,i) => {
    const logo = TEAM_IDS[e.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[e.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t4 += `<tr><td style="${tdS}text-align:center;font-weight:600;">${i+1}</td>`;
    t4 += `<td style="${tdS}">${logo} ${TEAM_ABBREV[e.team]||e.team}</td>`;
    t4 += `<td style="${tdS}font-weight:600;">${e.player}</td>`;
    t4 += `<td style="${tdS}color:${sColor(e.status)};font-weight:700;">${e.status}</td>`;
    t4 += `<td style="${tdS}">${e.injury||''}</td>`;
    t4 += `<td style="${tdS}text-align:right;font-weight:600;">${fmtSalFull(e.salary)}</td></tr>`;
  });
  t4 += `</tbody></table>`;

  return [t1, t2, t3, t4];
}

function copyPrestoHTML(btn) {
  const sections = buildPrestoHTML();
  const html = `<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">\n${sections.join('\n<br>\n')}\n</div>`;
  navigator.clipboard.writeText(html).then(() => {
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!'; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
  });
}

// ==========================================
// REPORT MODE (non-admin)
// ==========================================
let sectionsHTML = [];
let purgeActive = false;

async function initReport() {
  try {
    const { prev } = await loadData();
    buildReportSections(prev);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('preview').style.display = 'block';
    showTab(-1, document.querySelector('.tab-bar button.active'));
  } catch(e) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').textContent = 'Error: ' + e.message;
  }
}

function buildReportSections(prev) {
  // Reuse buildPrestoHTML logic for the preview
  const merged = jsonEntries; // no modifications in report mode
  const lat = {};
  for (const e of merged) { lat[e.player] = e; }

  const sections = buildPrestoHTMLFromData(merged, lat, prev);
  sectionsHTML = sections;
}

function buildPrestoHTMLFromData(entries, lat, prv) {
  // Same logic as buildPrestoHTML but using provided data
  const today = todayISO();
  const tStyle = 'border-collapse:collapse;width:100%;font-family:Arial,sans-serif;font-size:14px;';
  const thStyle = 'background:#1a1a2e;color:#fff;padding:10px 12px;text-align:left;border:1px solid #333;';
  const tdS = 'padding:8px 12px;border:1px solid #ddd;';

  const todayEntries = entries.filter(e => e.date === today)
    .filter(e => !purgeActive || e.status !== 'Available')
    .map(e => {
      const p = prv[e.player], r = roster[e.player] || {};
      return { player:e.player, status:e.status, injury:e.injury, prevStatus:p?p.status:'Available', team:r.team||'', salary:r.salary||0 };
    }).sort((a,b) => {
      if (a.team !== b.team) return a.team.localeCompare(b.team);
      return (STATUS_GRAVITY[a.status]||4) - (STATUS_GRAVITY[b.status]||4);
    });

  let t1 = `<table style="${tStyle}"><thead><tr>`;
  t1 += `<th style="${thStyle}">Team</th><th style="${thStyle}">Player</th><th style="${thStyle}">Status</th><th style="${thStyle}">Injury</th><th style="${thStyle}">Prev</th>`;
  t1 += `</tr></thead><tbody>`;
  if (!todayEntries.length) {
    t1 += `<tr><td colspan="5" style="${tdS}text-align:center;color:#888;">No updates today</td></tr>`;
  }
  for (const e of todayEntries) {
    const logo = TEAM_IDS[e.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[e.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t1 += `<tr><td style="${tdS}">${logo} ${TEAM_ABBREV[e.team]||e.team}</td>`;
    t1 += `<td style="${tdS}font-weight:600;">${e.player}</td>`;
    t1 += `<td style="${tdS}color:${sColor(e.status)};font-weight:700;">${e.status}</td>`;
    t1 += `<td style="${tdS}">${e.injury}</td>`;
    t1 += `<td style="${tdS}color:${sColor(e.prevStatus)};font-weight:700;">${e.prevStatus}</td></tr>`;
  }
  t1 += `</tbody></table>`;

  const allInjured = Object.entries(lat)
    .filter(([_,e]) => e.status !== 'Available')
    .filter(([_,e]) => !purgeActive || e.status !== 'Available')
    .map(([name,e]) => ({ player:name, ...e, team:(roster[name]||{}).team||'', salary:(roster[name]||{}).salary||0, days:daysMap[name]||0 }))
    .sort((a,b) => {
      if (a.team !== b.team) return a.team.localeCompare(b.team);
      return (STATUS_GRAVITY[a.status]||4) - (STATUS_GRAVITY[b.status]||4);
    });

  let t2 = `<table style="${tStyle}"><thead><tr>`;
  t2 += `<th style="${thStyle}">Team</th><th style="${thStyle}">Player</th><th style="${thStyle}">Status</th><th style="${thStyle}">Injury</th><th style="${thStyle}">Since</th><th style="${thStyle}">Days</th><th style="${thStyle}">Salary</th>`;
  t2 += `</tr></thead><tbody>`;
  for (const e of allInjured) {
    const logo = TEAM_IDS[e.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[e.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t2 += `<tr><td style="${tdS}">${logo} ${TEAM_ABBREV[e.team]||e.team}</td>`;
    t2 += `<td style="${tdS}font-weight:600;">${e.player}</td>`;
    t2 += `<td style="${tdS}color:${sColor(e.status)};font-weight:700;">${e.status}</td>`;
    t2 += `<td style="${tdS}">${e.injury||''}</td>`;
    t2 += `<td style="${tdS}">${e.date ? fmtDate(e.date) : ''}</td>`;
    t2 += `<td style="${tdS}text-align:center;">${e.days||''}</td>`;
    t2 += `<td style="${tdS}text-align:right;">${fmtSal(e.salary)}</td></tr>`;
  }
  t2 += `</tbody></table>`;

  const teamInjSal = {};
  for (const e of allInjured) {
    if (e.status === 'Out' || e.status === 'Doubtful') {
      teamInjSal[e.team] = (teamInjSal[e.team]||0) + e.salary;
    }
  }
  let totalNBASal = 0, totalNBAInj = 0;
  for (const t of NBA_TEAMS) { totalNBASal += teamSalaries[t]||0; totalNBAInj += teamInjSal[t]||0; }

  const teamRowsArr = NBA_TEAMS.map(t => ({
    team:t, injured:teamInjSal[t]||0, total:teamSalaries[t]||0,
    pct: teamSalaries[t] ? ((teamInjSal[t]||0)/teamSalaries[t]*100) : 0
  })).sort((a,b) => b.injured - a.injured);

  let t3 = `<table style="${tStyle}"><thead><tr>`;
  t3 += `<th style="${thStyle}">Team</th><th style="${thStyle}">Injured Salary</th><th style="${thStyle}">Total Salary</th><th style="${thStyle}">%</th>`;
  t3 += `</tr></thead><tbody>`;
  for (const r of teamRowsArr) {
    const logo = TEAM_IDS[r.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[r.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t3 += `<tr><td style="${tdS}">${logo} ${r.team}</td>`;
    t3 += `<td style="${tdS}text-align:right;font-weight:600;${r.injured?'color:#ef4444;':''}">${fmtSalFull(r.injured)}</td>`;
    t3 += `<td style="${tdS}text-align:right;">${fmtSalFull(r.total)}</td>`;
    t3 += `<td style="${tdS}text-align:right;">${r.pct.toFixed(1)}%</td></tr>`;
  }
  const nbaLogo = `<img src="https://cdn.nba.com/logos/leagues/logo-nba.svg" width="24" height="24" style="vertical-align:middle;">`;
  t3 += `<tr style="background:#1a1a2e;color:#fff;font-weight:700;">`;
  t3 += `<td style="${tdS}border-color:#333;">${nbaLogo} NBA</td>`;
  t3 += `<td style="${tdS}text-align:right;border-color:#333;color:#ef4444;">${fmtSalFull(totalNBAInj)}</td>`;
  t3 += `<td style="${tdS}text-align:right;border-color:#333;">${fmtSalFull(totalNBASal)}</td>`;
  t3 += `<td style="${tdS}text-align:right;border-color:#333;">${totalNBASal?(totalNBAInj/totalNBASal*100).toFixed(1):'0.0'}%</td></tr>`;
  t3 += `</tbody></table>`;

  const topPaid = [...allInjured].sort((a,b) => b.salary - a.salary).slice(0,25);
  let t4 = `<table style="${tStyle}"><thead><tr>`;
  t4 += `<th style="${thStyle}">#</th><th style="${thStyle}">Team</th><th style="${thStyle}">Player</th><th style="${thStyle}">Status</th><th style="${thStyle}">Injury</th><th style="${thStyle}">Salary</th>`;
  t4 += `</tr></thead><tbody>`;
  topPaid.forEach((e,i) => {
    const logo = TEAM_IDS[e.team] ? `<img src="https://cdn.nba.com/logos/nba/${TEAM_IDS[e.team]}/primary/L/logo.svg" width="24" height="24" style="vertical-align:middle;">` : '';
    t4 += `<tr><td style="${tdS}text-align:center;font-weight:600;">${i+1}</td>`;
    t4 += `<td style="${tdS}">${logo} ${TEAM_ABBREV[e.team]||e.team}</td>`;
    t4 += `<td style="${tdS}font-weight:600;">${e.player}</td>`;
    t4 += `<td style="${tdS}color:${sColor(e.status)};font-weight:700;">${e.status}</td>`;
    t4 += `<td style="${tdS}">${e.injury||''}</td>`;
    t4 += `<td style="${tdS}text-align:right;font-weight:600;">${fmtSalFull(e.salary)}</td></tr>`;
  });
  t4 += `</tbody></table>`;

  return [t1, t2, t3, t4];
}

function showTab(idx, btn) {
  document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('preview').innerHTML = idx === -1 ? sectionsHTML.join('<br>') : (sectionsHTML[idx] || '');
}

function copyToClipboard(html, btn) {
  const orig = btn.textContent;
  const w = `<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">\n${html}\n</div>`;
  navigator.clipboard.writeText(w).then(() => {
    btn.textContent = '‚úì Copied!'; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
  });
}
function copyAll(btn) { copyToClipboard(sectionsHTML.join('\n<br>\n'), btn); }
function copySection(idx, btn) { if (sectionsHTML[idx]) copyToClipboard(sectionsHTML[idx], btn); }

async function refreshReport(btn) {
  const o = btn.textContent; btn.textContent = '‚è≥ Refreshing...'; btn.disabled = true;
  try {
    const { prev } = await loadData();
    buildReportSections(prev);
    showTab(-1, document.querySelector('.tab-bar button.active'));
  } catch(e) {}
  btn.textContent = '‚úì Updated!'; btn.classList.add('success');
  setTimeout(() => { btn.textContent = o; btn.classList.remove('success'); btn.disabled = false; }, 2000);
}

function togglePurge(btn) {
  purgeActive = !purgeActive;
  btn.classList.toggle('active', purgeActive);
  btn.style.background = purgeActive ? 'rgba(239,68,68,0.2)' : '';
  // Rebuild
  const lat = {}, prv = {};
  for (const e of jsonEntries) {
    if (lat[e.player]) prv[e.player] = lat[e.player];
    lat[e.player] = e;
  }
  sectionsHTML = buildPrestoHTMLFromData(jsonEntries, lat, prv);
  showTab(-1, document.querySelector('.tab-bar button.active'));
}
</script>
</body>
</html>
